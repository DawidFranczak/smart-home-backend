from rest_framework import serializers
from rest_framework.serializers import UniqueTogetherValidator

from communication_protocol.message_event import MessageEvent
from lamp.models import Lamp

from .models import Rfid, Card
from .command import add_card


class RfidSerializer(serializers.ModelSerializer):
    cards = serializers.SerializerMethodField()
    controlled_lamp = serializers.SerializerMethodField()

    class Meta:
        model = Rfid
        exclude = [
            "port",
            "mac",
        ]

    def get_controlled_lamp(self, obj: Rfid):
        if not obj.controlled_lamp:
            return None
        try:
            return {"name": obj.controlled_lamp.name, "id": obj.controlled_lamp.id}
        except Lamp.DoesNotExist:
            return None

    def get_cards(self, obj: Rfid):
        cards = obj.cards.all()
        serializer = CardSerializer(cards, many=True)
        return serializer.data


class CardSerializer(serializers.ModelSerializer):
    class Meta:
        model = Card
        exclude = ["uid"]
        validators = [
            UniqueTogetherValidator(
                queryset=Card.objects.all(),
                fields=[
                    "rfid",
                    "name",
                ],
                message="Karta o tej nazwie juzÌ‡ istnieje",
            ),
        ]


class RfidSerializerDevice(RfidSerializer):
    class Meta:
        model = Rfid
        fields = "__all__"
